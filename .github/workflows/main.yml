name: Build and deploy dev images for AWS ECS

on:
  pull_request:
    types:
      - closed
    branches:
      - main

jobs:
  build:
    name: Build Image and Deploy ECS
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        
      - name: Extract Changes from Pull Request Description
        run: |
          # Get the pull request description
          PR_DESCRIPTION=$(curl -sH "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}" \
              | jq -r '.body')

          echo "Github Info: $(echo '${{ toJson(github.event.pull_request.body) }}' | jq -r tostring)"
          echo "PR DESC: $PR_DESCRIPTION"

          # Extract the changes using a regular expression
          CHANGES=$(echo "$PR_DESCRIPTION" | grep -oP '\*\*Changes:\*\*\s*[\n\s\S]*?(?=\*\*)' | grep -oP '-\s*\K.+')

          # Store the changes in an environment variable
          echo "CHANGES=$CHANGES" >> $GITHUB_ENV

      - name: Display Changes
        run: |
          # Display the changes stored in the environment variable
          echo "Changes: $CHANGES"

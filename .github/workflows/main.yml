name: Fetch PR Details

on:
  pull_request:
    types:
      - closed

jobs:
  build:
    name: Build Image and Deploy ECS
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Extract PR details
        run: |
          PR_BODY=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" ${{ github.api_url }}/repos/${{ github.repository }}/pulls/${{ github.event.number }} | jq -r .body)            
          echo "PR Body: ${PR_BODY}"
          # Extract Name and Version
          NAME=$(echo "$PR_BODY" | grep '**Name**' | cut -d':' -f2 | tr -d '[:space:]')
          VERSION=$(echo "$PR_BODY" | grep '**Version**' | cut -d':' -f2 | tr -d '[:space:]')

          # Extract Features, Updates, Bugs, and Additional Notes
          FEATURES=$(echo "$PR_BODY" | awk -v RS= '/### Feature:/ {print}' | tail -n +2 | sed '/^$/d')
          UPDATES=$(echo "$PR_BODY" | awk -v RS= '/### Update:/ {print}' | tail -n +2 | sed '/^$/d')
          BUGS=$(echo "$PR_BODY" | awk -v RS= '/### Bug:/ {print}' | tail -n +2 | sed '/^$/d')
          ADDITIONAL_NOTES=$(echo "$PR_BODY" | awk -v RS= '/### Additional Notes:/ {print}' | tail -n +2 | sed '/^$/d')

          # Set output variables
          echo "::set-output name=name::${NAME}"
          echo "::set-output name=version::${VERSION}"
          echo "::set-output name=features::${FEATURES}"
          echo "::set-output name=updates::${UPDATES}"
          echo "::set-output name=bugs::${BUGS}"
          echo "::set-output name=additional_notes::${ADDITIONAL_NOTES}"

      - name: Display extracted details
        run: |
          echo "Name: ${{ steps.extract.outputs.name }}"
          echo "Version: ${{ steps.extract.outputs.version }}"
          echo "Features: ${{ steps.extract.outputs.features }}"
          echo "Updates: ${{ steps.extract.outputs.updates }}"
          echo "Bugs: ${{ steps.extract.outputs.bugs }}"
          echo "Additional Notes: ${{ steps.extract.outputs.additional_notes }}"
